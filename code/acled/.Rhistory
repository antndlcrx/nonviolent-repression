mutate(comparison = "Census 2020")
census_for_aug <- combined_strata %>%
filter(source == "Census 2020") %>%
mutate(comparison = "Census  2020")
# plot differences
ggplot(combined_strata, aes(x = university_education,
y = proportion,
color = source, shape = source)) +
geom_point(size = 3) +
geom_line(aes(group = interaction(age_group, university_education))) +
facet_grid(gender ~ age_group) +
scale_color_manual(values = c("Census 2020" = "red", "March Survey" = "purple",
"February Survey" = "lightblue", "August Survey" = "darkgreen")) +
scale_shape_manual(values = c("Census 2020" = 16,"March Survey" = 19,
"February Survey" = 17, "August Survey" = 18)) +
labs(x = "University Education", y = "Proportion", shape = "Source", color = "Source") +
theme(legend.position = "bottom") +
theme_bw()
survey_march_strata <- survey_march %>%
group_by(gender, age_group, university_education) %>%
summarise(count = n()) %>%
mutate(proportion = count / nrow(survey_feb),
source = "March Survey")
survey_feb_strata <- survey_feb %>%
group_by(gender, age_group, university_education) %>%
summarise(count = n()) %>%
mutate(proportion = count / nrow(survey_feb),
source = "February Survey")
survey_aug_strata <- survey_aug %>%
group_by(gender, age_group, university_education) %>%
summarise(count = n()) %>%
mutate(proportion = count / nrow(survey_feb),
source = "August Survey")
pop_strata <- ru_population_frame %>%
ungroup() %>%
mutate(proportion = Freq/sum(Freq),
source = "Census 2020")
combined_strata <- combined_strata <- rbind(survey_march_strata, survey_feb_strata, survey_aug_strata, pop_strata)
census_for_feb <- combined_strata %>%
filter(source == "Census 2020") %>%
mutate(comparison = "Census 2020")
census_for_aug <- combined_strata %>%
filter(source == "Census 2020") %>%
mutate(comparison = "Census  2020")
# plot differences
ggplot(combined_strata, aes(x = university_education,
y = proportion,
color = source, shape = source)) +
geom_point(size = 3) +
geom_line(aes(group = interaction(age_group, university_education))) +
facet_grid(gender ~ age_group) +
scale_color_manual(values = c("Census 2020" = "red", "March Survey" = "purple",
"February Survey" = "lightblue", "August Survey" = "darkgreen")) +
scale_shape_manual(values = c("Census 2020" = 16,"March Survey" = 15,
"February Survey" = 17, "August Survey" = 18)) +
labs(x = "University Education", y = "Proportion", shape = "Source", color = "Source") +
theme(legend.position = "bottom") +
theme_bw()
unweighted_data <- svydesign(ids = ~1, data = survey_march)
weighted <- postStratify(unweighted_data, ~age_group + gender + university_education,
ru_population_frame, partial=TRUE)
# save weights
survey_march$weight_poststratify <- weights(weighted)
sum_march <- round(summary(weights(weighted)), 2)
sum_march_mat <-  matrix(as.numeric(sum_march), nrow = 1,
dimnames = list(c("Value"),
names(sum_march)
)
)
kable(sum_march_mat,
caption = "March Survey PostStratify Weights Summary",
align = 'c',
format = "markdown")
## survey library ##
unweighted_data <- svydesign(ids = ~1, data = survey_feb)
weighted <- postStratify(unweighted_data, ~age_group + gender + university_education,
ru_population_frame, partial=TRUE)
# save weights
survey_feb$weight_poststratify <- weights(weighted)
sum_feb <- round(summary(weights(weighted)), 2)
sum_feb_mat <-  matrix(as.numeric(sum_feb), nrow = 1,
dimnames = list(c("Value"),
names(sum_feb)
)
)
kable(sum_feb_mat,
caption = "February Survey PostStratify Weights Summary",
align = 'c',
format = "markdown")
top_five_rows_feb <- survey_feb %>%
distinct(weight_poststratify, .keep_all = TRUE) %>%
arrange(desc(weight_poststratify)) %>%
select(age_group, gender, university_education, weight_poststratify) %>%
slice_head(n = 5)
kable(top_five_rows_feb, caption = "February Survey, Top Five Rows by Unique Weight", align = 'c')
## survey library ##
unweighted_data <- svydesign(ids = ~1, data = survey_aug)
weighted <- postStratify(unweighted_data, ~age_group + gender + university_education,
ru_population_frame, partial=TRUE)
# save weights
survey_aug$weight_poststratify <- weights(weighted)
sum_aug <- round(summary(weights(weighted)), 2)
sum_aug_mat <-  matrix(as.numeric(sum_aug), nrow = 1,
dimnames = list(c("Value"),
names(sum_aug)
)
)
kable(sum_aug_mat,
caption = "August Survey PostStratify Weights Summary",
align = 'c',
format = "markdown")
top_five_rows_aug <- survey_aug  %>%
distinct(weight_poststratify, .keep_all = TRUE) %>%
arrange(desc(weight_poststratify)) %>%
select(age_group, gender, university_education, weight_poststratify)%>%
head(5)
kable(top_five_rows_aug, caption = "August Survey, Top Five Rows by Weight", align = 'c')
top_five_rows_march <- survey_march  %>%
distinct(weight_poststratify, .keep_all = TRUE) %>%
arrange(desc(weight_poststratify)) %>%
select(age_group, gender, university_education, weight_poststratify)%>%
head(5)
kable(top_five_rows_march, caption = "March Survey, Top Five Rows by Weight", align = 'c')
survey_march_selected <- survey_march %>%
mutate(Survey = 'March') %>%
select(weight_poststratify, Survey)
survey_feb_selected <- survey_feb %>%
mutate(Survey = 'February') %>%
select(weight_poststratify, Survey)
survey_aug_selected <- survey_aug %>%
mutate(Survey = 'August') %>%
select(weight_poststratify, Survey)
combined_weights <- rbind(survey_march_selected, survey_feb_selected, survey_aug_selected)
ggplot(combined_weights, aes(x = weight_poststratify, fill = Survey)) +
geom_histogram(data = subset(combined_weights, Survey == 'February'), bins = 100, alpha = 0.5, color = "black") +
geom_histogram(data = subset(combined_weights, Survey == 'August'), bins = 100, alpha = 0.5, color = "black") +
scale_fill_manual(values = c("March" = "lightblue", "February" = "blue", "August" = "red")) +
theme_minimal() +
labs(title = "Distribution of Weights by Survey",
x = "Weight",
y = "Frequency")
survey_march_selected <- survey_march %>%
mutate(Survey = 'March') %>%
select(weight_poststratify, Survey)
survey_feb_selected <- survey_feb %>%
mutate(Survey = 'February') %>%
select(weight_poststratify, Survey)
survey_aug_selected <- survey_aug %>%
mutate(Survey = 'August') %>%
select(weight_poststratify, Survey)
combined_weights <- rbind(survey_march_selected, survey_feb_selected, survey_aug_selected)
ggplot(combined_weights, aes(x = weight_poststratify, fill = Survey)) +
geom_histogram(data = subset(combined_weights, Survey == 'March'), bins = 100, alpha = 0.5, color = "black") +
geom_histogram(data = subset(combined_weights, Survey == 'February'), bins = 100, alpha = 0.5, color = "black") +
geom_histogram(data = subset(combined_weights, Survey == 'August'), bins = 100, alpha = 0.5, color = "black") +
scale_fill_manual(values = c("March" = "lightblue", "February" = "blue", "August" = "red")) +
theme_minimal() +
labs(title = "Distribution of Weights by Survey",
x = "Weight",
y = "Frequency")
plot_march <- ggplot(survey_march_selected, aes(x = weight_poststratify)) +
geom_histogram(bins = 100, fill = "lightblue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "March: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_feb <- ggplot(survey_feb_selected, aes(x = weight_poststratify)) +
geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "February: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_aug <- ggplot(survey_aug_selected, aes(x = weight_poststratify)) +
geom_histogram(bins = 100, fill = "red", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "August: Distribution of Weights",
x = "Weight",
y = "Frequency")
grid.arrange(plot_feb, plot_aug, plot_march, ncol = 3)
plot_march <- ggplot(survey_march_selected, aes(x = weight_poststratify)) +
geom_histogram(bins = 100, fill = "lightblue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "March: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_feb <- ggplot(survey_feb_selected, aes(x = weight_poststratify)) +
geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "February: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_aug <- ggplot(survey_aug_selected, aes(x = weight_poststratify)) +
geom_histogram(bins = 100, fill = "red", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "August: Distribution of Weights",
x = "Weight",
y = "Frequency")
grid.arrange(plot_march, plot_feb, plot_aug, ncol = 3)
survey_march_strata <- survey_march %>%
group_by(gender, age_group, university_education) %>%
summarise(count = n()) %>%
mutate(proportion = count / nrow(survey_march),
source = "March Survey")
pop_strata <- ru_population_frame %>%
ungroup() %>%
mutate(proportion = Freq/sum(Freq),
source = "Census 2020")
combined_strata <- combined_strata <- rbind(survey_march_strata,  pop_strata)
weights_march_strata_man <- left_join(survey_march_strata,
pop_strata,
c("gender", "age_group", "university_education")) %>%
rename(population_proportion = proportion.y,
sample_proportion = proportion.x)  %>%
# calculate weights as popul prop/sample prop
mutate(weight = population_proportion / sample_proportion)
survey_march <- survey_march %>%
left_join(weights_march_strata_man, by = c("age_group", "gender", "university_education")) %>%
rename(weight_manually_calculated = weight)
sum_man_march <- round(summary(weights_march_strata_man$weight), 2)
sum_man_march_mat <-  matrix(as.numeric(sum_man_march), nrow = 1,
dimnames = list(c("Value"),
names(sum_man_march)
)
)
kable(sum_man_march_mat,
caption = "March Survey Weights Summary",
align = 'c',
format = "markdown")
# calculate weights and print the df with weights
weights_feb_strata_man <- left_join(survey_feb_strata,
pop_strata,
c("gender", "age_group", "university_education")) %>%
rename(population_proportion = proportion.y,
sample_proportion = proportion.x)  %>%
# calculate weights as popul prop/sample prop
mutate(weight = population_proportion / sample_proportion)
sum_man_feb <- round(summary(weights_feb_strata_man$weight), 2)
sum_man_feb_mat <-  matrix(as.numeric(sum_man_feb), nrow = 1,
dimnames = list(c("Value"),
names(sum_man_feb)
)
)
kable(sum_man_feb_mat,
caption = "February Survey Weights Summary",
align = 'c',
format = "markdown")
# calculate weights and print the df with weights
weights_aug_strata_man <- left_join(survey_aug_strata,
pop_strata,
c("gender", "age_group", "university_education")) %>%
rename(population_proportion = proportion.y,
sample_proportion = proportion.x)  %>%
# calculate weights as popul prop/sample prop
mutate(weight = population_proportion / sample_proportion)
sum_man_aug <- round(summary(weights_aug_strata_man$weight), 2)
sum_man_aug_mat <-  matrix(as.numeric(sum_man_aug), nrow = 1,
dimnames = list(c("Value"),
names(sum_man_aug)
)
)
kable(sum_man_aug_mat,
caption = "August Survey Weights Summary",
align = 'c',
format = "markdown")
weights_march_strata_man <- weights_march_strata_man %>%
mutate(Survey = 'March') %>%
select(weight, Survey, age_group, gender, university_education)
weights_feb_strata_man <- weights_feb_strata_man %>%
mutate(Survey = 'February') %>%
select(weight, Survey, age_group, gender, university_education)
weights_aug_strata_man <- weights_aug_strata_man %>%
mutate(Survey = 'August') %>%
select(weight, Survey,  age_group, gender, university_education)
combined_weights <- rbind(weights_march_strata_man, weights_feb_strata_man, weights_aug_strata_man)
ggplot(combined_weights, aes(x = weight, fill = Survey)) +
geom_histogram(data = subset(combined_weights, Survey == 'February'), bins = 100, alpha = 0.5, color = "black") +
geom_histogram(data = subset(combined_weights, Survey == 'August'), bins = 100, alpha = 0.5, color = "black") +
geom_histogram(data = subset(combined_weights, Survey == 'March'), bins = 100, alpha = 0.5, color = "black") +
scale_fill_manual(values = c("February" = "blue", "August" = "red", "March" = "lightblue")) +
theme_minimal() +
labs(title = "Distribution of Weights by Survey",
x = "Weight",
y = "Frequency")
plot_feb <- ggplot(weights_feb_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "February: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_aug <- ggplot(weights_aug_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "red", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "August: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_march <- ggplot(weights_march_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "lightblue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "March: Distribution of Weights",
x = "Weight",
y = "Frequency")
grid.arrange(plot_march, plot_feb, plot_aug, ncol = 2)
plot_feb <- ggplot(weights_feb_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "February: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_aug <- ggplot(weights_aug_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "red", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "August: Distribution of Weights",
x = "Weight",
y = "Frequency")
plot_march <- ggplot(weights_march_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "lightblue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(title = "March: Distribution of Weights",
x = "Weight",
y = "Frequency")
grid.arrange(plot_march, plot_feb, plot_aug, ncol = 3)
knitr::opts_chunk$set(echo = FALSE,
warning = FALSE,
message = FALSE)
Sys.getlocale()
# Set this to a locale that supports Cyrillic, for example, on Windows
Sys.setlocale("LC_ALL", "Russian")
##### Set Up #####
pacman::p_load(tidyverse, readr, broom,
lubridate, gt, gtsummary, survey, readxl,
gridExtra, knitr, haven)
# categories for education
uni_education <- c("Высшее образование (магистратура)",
"Высшее образование (бакалавриат / специалитет)",
"Научная степень (кандидат, доктор наук)")
na_education <- c("Затрудняюсь ответить", "Отказ от ответа", "no_answer")
# load levada data
levada_omnibus <- read_sav("data/surveys/levada_omnibus") %>%
mutate(gender = fct_recode(as.factor(qS1),
"Man"= "1",
"Woman" = "2"),
#adjust age
age_group = case_when(
as.numeric(qS2) %in% c(18:24) ~ '18-24',
as.numeric(qS2) %in% c(25:34) ~ '25-34',
as.numeric(qS2) %in% c(35:44) ~ '35-44',
as.numeric(qS2) %in% c(45:54) ~ '45-54',
as.numeric(qS2) %in% c(55:64) ~ '55-64',
as.numeric(qS2) >= 65 ~ '65+',
TRUE ~ NA)
)
# load survey data
survey_march <- read_csv("data/surveys/survey_march_post_election.csv",
locale = locale(encoding = "UTF-8")) %>%
mutate(gender = fct_recode(Q4,
"Man"= "Мужской",
"Woman" = "Женский"),
#adjust age
age_group = case_when(
as.numeric(Q1) %in% c(18:24) ~ '18-24',
as.numeric(Q1) %in% c(25:34) ~ '25-34',
as.numeric(Q1) %in% c(35:44) ~ '35-44',
as.numeric(Q1) %in% c(45:54) ~ '45-54',
as.numeric(Q1) %in% c(55:64) ~ '55-64',
as.numeric(Q1) >= 65 ~ '65+',
TRUE ~ NA),
university_education = case_when(Q5 %in% uni_education ~ "BA+",
TRUE ~ "BA-")
)
survey_feb <- read_xlsx("data/surveys/survey_feb.xlsx")
# clean data
column_descriptions <- as.character(unlist(survey_feb[1, ]))
names(column_descriptions) <- names(survey_feb)
# example, call: column_descriptions["Q1"]
# remove first row
survey_feb <- survey_feb[-1,]
survey_feb <- survey_feb %>%
mutate(
gender = as.factor(Q4),
# adjust dates
StartDate = as.POSIXct((as.numeric(StartDate) - 25569) * 86400, origin = "1970-01-01", tz = "UTC"),
EndDate = as.POSIXct((as.numeric(EndDate) - 25569) * 86400, origin = "1970-01-01", tz = "UTC"),
RecordedDate = as.POSIXct((as.numeric(RecordedDate) - 25569) * 86400, origin = "1970-01-01", tz = "UTC"),
# adjust education
# Q5 %in% na_education ~ "NA" (incude to count NAs)
university_education = case_when(Q5 %in% uni_education ~ "BA+",
TRUE ~ "BA-"),
gender = fct_recode(gender,
"Man"= "Мужской",
"Woman" = "Женский"),
#adjust age
age_group = case_when(
as.numeric(Q1) %in% c(18:24) ~ '18-24',
as.numeric(Q1) %in% c(25:34) ~ '25-34',
as.numeric(Q1) %in% c(35:44) ~ '35-44',
as.numeric(Q1) %in% c(45:54) ~ '45-54',
as.numeric(Q1) %in% c(55:64) ~ '55-64',
as.numeric(Q1) >= 65 ~ '65+',
TRUE ~ NA),
# pull list experiment into one variable
list_treatment = case_when(is.na(`Q14 - version 2`) ~ 0,
TRUE ~ 1),
list_count = coalesce(`Q14 - version 1`,
`Q14 - version 2`),
# pull framing experiment into one variable
frame_treatment = case_when(
`Q15 - Group 1` != 0 ~ "Group 1",
`Q15 - Group 2` != 0 ~ "Group 2",
`Q15 - Group 3` != 0 ~ "Group 3",
`Q15 - Group 4` != 0 ~ "Group 4",
`Q15 - Group 5` != 0 ~ "Group 5",
`Q15 - Group 6` != 0 ~ "Group 6",
`Q15 - Group 7` != 0 ~ "Group 7",
`Q15 - Group 8` != 0 ~ "Group 8",
TRUE ~ NA_character_
)
,
Q15 = coalesce(`Q15 - Group 1`, `Q15 - Group 2`, `Q15 - Group 3`, `Q15 - Group 4`,
`Q15 - Group 5`, `Q15 - Group 6`, `Q15 - Group 7`, `Q15 - Group 8`)
)
# load population frame minus rows containing information on underaged categories and redundant total categories
survey_aug <- read_csv("data/surveys/survey_aug.csv",
locale = locale(encoding = "UTF-8")) %>%
# adjust education
# education %in% na_education ~ "NA"
filter(gender != "no_answer") %>%
mutate(university_education = case_when(
education %in% uni_education ~ "BA+",
TRUE ~ "BA-"),
gender = fct_recode(gender,
"Man"= "Мужской",
"Woman" = "Женский")
)
# -c(1:3,16:18)
ru_population_frame <- read_csv("data/surveys/ru_population_frame.csv")[-c(1:3,16:18), -c(3,7)]
wider_age_categories <- list(
'18-24' = c('18 – 19', '20 – 24'),
'25-34' = c('25 – 29', '30 – 34'),
'35-44' = c('35 – 39', '40 – 44'),
'45-54' = c('45 – 49', '50 – 54'),
'55-64' = c('55 – 59', '60 – 64'),
'65+' = c('65 – 69', '70 и более')
)
map_age_category <- function(age) {
for (category in names(wider_age_categories)) {
if (age %in% wider_age_categories[[category]]) {
return(category)
}
}
return(NA)
}
ru_population_frame$wider_age <- sapply(ru_population_frame$Age, map_age_category)
collapsed_df <- ru_population_frame %>%
group_by(Gender, wider_age) %>%
summarise(
`BA+` = sum(`BA+`, na.rm = TRUE),
`BA-` = sum(`BA-`, na.rm = TRUE) + sum(`NA`, na.rm = TRUE)
)
# harmonise categories
ru_population_frame <- collapsed_df %>%
mutate(Gender = fct_recode(Gender,
"Man"= "Men",
"Woman" = "Women")
) %>%
pivot_longer(
cols = c("BA+", "BA-"),
names_to = "Education",
values_to = "Count"
)
# harmonise features
colnames(ru_population_frame) <- c("gender", "age_group", "university_education",
"Freq")
# load levada data
levada_omnibus <- read_sav("data/surveys/levada_omnibus") %>%
mutate(gender = fct_recode(as.factor(qS1),
"Man"= "1",
"Woman" = "2"),
#adjust age
age_group = case_when(
as.numeric(qS2) %in% c(18:24) ~ '18-24',
as.numeric(qS2) %in% c(25:34) ~ '25-34',
as.numeric(qS2) %in% c(35:44) ~ '35-44',
as.numeric(qS2) %in% c(45:54) ~ '45-54',
as.numeric(qS2) %in% c(55:64) ~ '55-64',
as.numeric(qS2) >= 65 ~ '65+',
TRUE ~ NA),
university_education = case_when(qS3 == 6 ~ "BA+",
TRUE ~ "BA-")
)
# helper funcitons
calculate_shares <- function(dataset, dataset_name) {
dataset %>%
pivot_longer(cols = c(age_group, gender, university_education), names_to = "Variable", values_to = "Values") %>%
group_by(Variable, Values) %>%
summarise(Share = n() / nrow(dataset), .groups = 'drop') %>%
mutate(Survey = dataset_name,
Share = round(Share, 2))
}
plot_feb <- ggplot(weights_feb_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(x = "Weight", y = "Frequency")
plot_aug <- ggplot(weights_aug_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "red", color = "black", alpha = 0.5) +
theme_minimal() +
labs(x = "Weight", y = "Frequency")
plot_march <- ggplot(weights_march_strata_man, aes(x = weight)) +
geom_histogram(bins = 100, fill = "lightblue", color = "black", alpha = 0.5) +
theme_minimal() +
labs(x = "Weight", y = "Frequency")
grid.arrange(plot_feb, plot_aug, plot_march, ncol = 3, top = "Distribution of Weights Across Months")
View(plot_feb)
