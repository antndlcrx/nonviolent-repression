---
title: "February Survey Report"
author: "Maksim Zubok"
date: 
output: 
  pdf_document:
    latex_engine: lualatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

Sys.getlocale()
# Set this to a locale that supports Cyrillic, for example, on Windows
Sys.setlocale("LC_ALL", "Russian")

##### Set Up #####
pacman::p_load(tidyverse, readr, broom, 
               lubridate, gt, gtsummary, survey, readxl,
               gridExtra, knitr)


# load survey data
survey_feb <- read_xlsx("data/surveys/survey_feb.xlsx")
# clean data
column_descriptions <- as.character(unlist(survey_feb[1, ]))
names(column_descriptions) <- names(survey_feb)
# example, call: column_descriptions["Q1"]

# remove first row
survey_feb <- survey_feb[-1,]

# categories for education
uni_education <- c("Высшее образование (магистратура)",
                   "Высшее образование (бакалавриат / специалитет)",
                   "Научная степень (кандидат, доктор наук)")

na_education <- c("Затрудняюсь ответить", "Отказ от ответа", "no_answer")

survey_feb <- survey_feb %>%
  mutate(
    gender = as.factor(Q4),
    # adjust dates 
    StartDate = as.POSIXct((as.numeric(StartDate) - 25569) * 86400, origin = "1970-01-01", tz = "UTC"),
    EndDate = as.POSIXct((as.numeric(EndDate) - 25569) * 86400, origin = "1970-01-01", tz = "UTC"),
    RecordedDate = as.POSIXct((as.numeric(RecordedDate) - 25569) * 86400, origin = "1970-01-01", tz = "UTC"),
    # adjust education
    # Q5 %in% na_education ~ "NA" (incude to count NAs)
    university_education = case_when(Q5 %in% uni_education ~ "BA+",
                                     TRUE ~ "BA-"),
    
    gender = fct_recode(gender,
                          "Man"= "Мужской",
                          "Woman" = "Женский"),
    #adjust age
    age_group = case_when(
      as.numeric(Q1) %in% c(18:24) ~ '18-24',
      as.numeric(Q1) %in% c(25:34) ~ '25-34',
      as.numeric(Q1) %in% c(35:44) ~ '35-44',
      as.numeric(Q1) %in% c(45:54) ~ '45-54',
      as.numeric(Q1) %in% c(55:64) ~ '55-64',
      as.numeric(Q1) >= 65 ~ '65+',
      TRUE ~ NA),
    # pull list experiment into one variable 
    list_treatment = case_when(is.na(`Q14 - version 2`) ~ 0, 
                          TRUE ~ 1),
    list_count = coalesce(`Q14 - version 1`,
                          `Q14 - version 2`),
    # pull framing experiment into one variable
    frame_treatment = case_when(
      `Q15 - Group 1` != 0 ~ "Group 1",
      `Q15 - Group 2` != 0 ~ "Group 2",
      `Q15 - Group 3` != 0 ~ "Group 3",
      `Q15 - Group 4` != 0 ~ "Group 4",
      `Q15 - Group 5` != 0 ~ "Group 5",
      `Q15 - Group 6` != 0 ~ "Group 6",
      `Q15 - Group 7` != 0 ~ "Group 7",
      `Q15 - Group 8` != 0 ~ "Group 8",
      TRUE ~ NA_character_
    )
    ,
    Q15 = coalesce(`Q15 - Group 1`, `Q15 - Group 2`, `Q15 - Group 3`, `Q15 - Group 4`, 
                          `Q15 - Group 5`, `Q15 - Group 6`, `Q15 - Group 7`, `Q15 - Group 8`)
    
  )


# load population frame minus rows containing information on underaged categories and redundant total categories

survey_aug <- read_csv("data/surveys/survey_aug.csv",
                       locale = locale(encoding = "UTF-8")) %>% 
  # adjust education
  # education %in% na_education ~ "NA"
  filter(gender != "no_answer") %>% 
    mutate(university_education = case_when(
      education %in% uni_education ~ "BA+",
      TRUE ~ "BA-"),
      gender = fct_recode(gender,
                             "Man"= "Мужской",
                             "Woman" = "Женский")
    )
# -c(1:3,16:18) 
ru_population_frame <- read_csv("data/surveys/ru_population_frame.csv")[-c(1:3,16:18), -c(3,7)]

# Define wider age categories
wider_age_categories <- list(
  '18-24' = c('18 – 19', '20 – 24'),
  '25-34' = c('25 – 29', '30 – 34'),
  '35-44' = c('35 – 39', '40 – 44'),
  '45-54' = c('45 – 49', '50 – 54'),
  '55-64' = c('55 – 59', '60 – 64'),
  '65+' = c('65 – 69', '70 и более')
)

# Function to map each age range to its new category
map_age_category <- function(age) {
  for (category in names(wider_age_categories)) {
    if (age %in% wider_age_categories[[category]]) {
      return(category)
    }
  }
  return(NA)
}

ru_population_frame$wider_age <- sapply(ru_population_frame$Age, map_age_category)

# Group by Gender and the new WiderAge category, then summarise
collapsed_df <- ru_population_frame %>%
  group_by(Gender, wider_age) %>%
  summarise(
    `BA+` = sum(`BA+`, na.rm = TRUE),
    `BA-` = sum(`BA-`, na.rm = TRUE) + sum(`NA`, na.rm = TRUE)
  )


# harmonise categories
ru_population_frame <- collapsed_df %>%
  mutate(Gender = fct_recode(Gender,
                             "Man"= "Men",
                             "Woman" = "Women")
  ) %>%
  pivot_longer(
    cols = c("BA+", "BA-"), 
    names_to = "Education",
    values_to = "Count"
  )

# harmonise features
colnames(ru_population_frame) <- c("gender", "age_group", "university_education",
                                   "Freq")


```

## Intro

To create weights, I am working with the 2020
[census data](https://github.com/antndlcrx/nonviolent-repression/blob/main/data/surveys/Tom3_tab1_VPN-2020.xlsx), particularly the cross tabbed gender, age, and university education file [here](https://github.com/antndlcrx/nonviolent-repression/blob/main/data/surveys/ru_population_frame.csv). 

I did not include information about region of residence, even though we could do it after harmonising census data with the survey. 

```{r}
kable(head(ru_population_frame, 5),
      caption = "Population Frame: Census 2020",
      align = "c",
      format = "markdown")
```



## Sample to Population Comparison


```{r, echo=FALSE, fig.width=20, fig.height=7}
survey_feb_strata <- survey_feb %>% 
  group_by(gender, age_group, university_education) %>% 
  summarise(count = n()) %>%
  mutate(proportion = count / nrow(survey_feb),
         source = "February Survey")

survey_aug_strata <- survey_aug %>% 
  group_by(gender, age_group, university_education) %>% 
  summarise(count = n()) %>%
  mutate(proportion = count / nrow(survey_feb),
         source = "August Survey")

pop_strata <- ru_population_frame %>% 
  ungroup() %>% 
  mutate(proportion = Freq/sum(Freq),
         source = "Census 2020")

combined_strata <- combined_strata <- rbind(survey_feb_strata, survey_aug_strata, pop_strata) 

census_for_feb <- combined_strata %>% 
  filter(source == "Census 2020") %>% 
  mutate(comparison = "Census 2020")

census_for_aug <- combined_strata %>% 
  filter(source == "Census 2020") %>% 
  mutate(comparison = "Census  2020")

# plot differences
ggplot(combined_strata, aes(x = university_education,
                            y = proportion,
                            color = source, shape = source)) +
  geom_point(size = 3) +
  geom_line(aes(group = interaction(age_group, university_education))) +
  facet_grid(gender ~ age_group) +
  scale_color_manual(values = c("Census 2020" = "red", "February Survey" = "lightblue", "August Survey" = "darkgreen")) +
  scale_shape_manual(values = c("Census 2020" = 16, "February Survey" = 17, "August Survey" = 18)) +
  labs(x = "University Education", y = "Proportion", shape = "Source", color = "Source") +
  theme(legend.position = "bottom") +
  theme_bw()

```

The **main disparities between the February and the 2020 Census* are: 

- The biggest disparities are is women 55-64 and 65+ without education. The survey has `r nrow(survey_feb %>% filter(gender == "Woman" & age >= 65 & university_education == "BA+"))`` women in the latter category. 
- We have oversampled young women, especially 25-34 years old with university education, and undersampled men without university education across all age categories except 55- and 65+. 


## Weights witth Survey package

To compute post-stratification weights we rely on the `postStratify` function from the `survey` package. The function adjusts the sampling and replicate weights so that the joint distribution of a set of
post-stratifying variables matches the known population joint distribution. **However, the package documentation does not describe how exactly the adjustment is implemented.**

```{r }
## survey library ##
unweighted_data <- svydesign(ids = ~1, data = survey_feb)


weighted <- postStratify(unweighted_data, ~age_group + gender + university_education,
             ru_population_frame, partial=TRUE)

# save weights 
survey_feb$weight_poststratify <- weights(weighted)

sum_feb <- round(summary(weights(weighted)), 2)

sum_feb_mat <-  matrix(as.numeric(sum_feb), nrow = 1, 
                          dimnames = list(c("Value"),
                          names(sum_feb)
                          )
                          )

kable(sum_feb_mat, 
      caption = "February Survey PostStratify Weights Summary", 
      align = 'c', 
      format = "markdown")
```
Note: some strata had no observations in the survey (NA on education for some age gender groups). This means we had to ignore them in producing weights. 



```{r }
## survey library ##
unweighted_data <- svydesign(ids = ~1, data = survey_aug)


weighted <- postStratify(unweighted_data, ~age_group + gender + university_education,
             ru_population_frame, partial=TRUE)

# save weights 
survey_aug$weight_poststratify <- weights(weighted)

sum_aug <- round(summary(weights(weighted)), 2)

sum_aug_mat <-  matrix(as.numeric(sum_aug), nrow = 1, 
                          dimnames = list(c("Value"),
                          names(sum_aug)
                          )
                          )

kable(sum_aug_mat, 
      caption = "August Survey PostStratify Weights Summary", 
      align = 'c', 
      format = "markdown")
```

For August, we also see that some weights are much larger than others. As you can see in the graphs below, the distribution of weights is similarly skewed and the disparities between the bulk of the distribution and its tales are in the same orders of magnitude. However, the largest weight in Feb survey is three times bigger than the largest weight in Aug survey. 

The largest weights in both surveys relate to different population groups.


```{r echo=FALSE}
top_five_rows_feb <- survey_feb %>%
  distinct(weight_poststratify, .keep_all = TRUE) %>%  
  arrange(desc(weight_poststratify)) %>%
  select(age_group, gender, university_education, weight_poststratify) %>%
  slice_head(n = 5)

kable(top_five_rows_feb, caption = "February Survey, Top Five Rows by Unique Weight", align = 'c')

```

```{r echo=FALSE}
top_five_rows_aug <- survey_aug  %>%
  distinct(weight_poststratify, .keep_all = TRUE) %>% 
  arrange(desc(weight_poststratify)) %>% 
  select(age_group, gender, university_education, weight_poststratify)%>% 
  head(5)

kable(top_five_rows_aug, caption = "August Survey, Top Five Rows by Weight", align = 'c')
```


```{r, echo=FALSE}

survey_feb_selected <- survey_feb %>%
  mutate(Survey = 'February') %>%
  select(weight_poststratify, Survey)

survey_aug_selected <- survey_aug %>%
  mutate(Survey = 'August') %>%
  select(weight_poststratify, Survey)

combined_weights <- rbind(survey_feb_selected, survey_aug_selected)

ggplot(combined_weights, aes(x = weight_poststratify, fill = Survey)) +
  geom_histogram(data = subset(combined_weights, Survey == 'February'), bins = 100, alpha = 0.5, color = "black") +
  geom_histogram(data = subset(combined_weights, Survey == 'August'), bins = 100, alpha = 0.5, color = "black") +
  scale_fill_manual(values = c("February" = "blue", "August" = "red")) +
  theme_minimal() +
  labs(title = "Distribution of Weights by Survey",
       x = "Weight",
       y = "Frequency")


```

```{r echo=FALSE}
plot_feb <- ggplot(survey_feb_selected, aes(x = weight_poststratify)) +
  geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.5) +
  theme_minimal() +
  labs(title = "February: Distribution of Weights",
       x = "Weight",
       y = "Frequency")

plot_aug <- ggplot(survey_aug_selected, aes(x = weight_poststratify)) +
  geom_histogram(bins = 100, fill = "red", color = "black", alpha = 0.5) +
  theme_minimal() +
  labs(title = "August: Distribution of Weights",
       x = "Weight",
       y = "Frequency")

grid.arrange(plot_feb, plot_aug, ncol = 2)
```


## Weights created manually
To check the plausibility of resulting weights, we create alternative weights based on the population frequencies of the combination of the same strata (Yana's approach). The weights are calculated for each category:
\[ \text{weight}_i = \frac{\text{population frequency}_i}{\text{sample frequency}_i} \]


```{r }
# calculate weights and print the df with weights
weights_aug_strata_man <- left_join(survey_aug_strata,
                            pop_strata,
                            c("gender", "age_group", "university_education")) %>% 
  rename(population_proportion = proportion.y,
         sample_proportion = proportion.x)  %>% 
  # calculate weights as popul prop/sample prop
  mutate(weight = population_proportion / sample_proportion)

sum_man_aug <- round(summary(weights_aug_strata_man$weight), 2)

sum_man_aug_mat <-  matrix(as.numeric(sum_man_aug), nrow = 1, 
                          dimnames = list(c("Value"),
                          names(sum_man_aug)
                          )
                          )

kable(sum_man_aug_mat, 
      caption = "August Survey Weights Summary", 
      align = 'c', 
      format = "markdown")
```


```{r }
# calculate weights and print the df with weights
weights_feb_strata_man <- left_join(survey_feb_strata,
                            pop_strata,
                            c("gender", "age_group", "university_education")) %>% 
  rename(population_proportion = proportion.y,
         sample_proportion = proportion.x)  %>% 
  # calculate weights as popul prop/sample prop
  mutate(weight = population_proportion / sample_proportion)

sum_man_feb <- round(summary(weights_feb_strata_man$weight), 2)

sum_man_feb_mat <-  matrix(as.numeric(sum_man_feb), nrow = 1, 
                          dimnames = list(c("Value"),
                          names(sum_man_feb)
                          )
                          )

kable(sum_man_feb_mat, 
      caption = "February Survey Weights Summary", 
      align = 'c', 
      format = "markdown")
```

```{r echo=FALSE}

weights_feb_strata_man <- weights_feb_strata_man %>%
  mutate(Survey = 'February') %>%
  select(weight, Survey, age_group, gender, university_education)

weights_aug_strata_man <- weights_aug_strata_man %>%
  mutate(Survey = 'August') %>%
  select(weight, Survey,  age_group, gender, university_education)

combined_weights <- rbind(weights_feb_strata_man, weights_aug_strata_man)

ggplot(combined_weights, aes(x = weight, fill = Survey)) +
  geom_histogram(data = subset(combined_weights, Survey == 'February'), bins = 100, alpha = 0.5, color = "black") +
  geom_histogram(data = subset(combined_weights, Survey == 'August'), bins = 100, alpha = 0.5, color = "black") +
  scale_fill_manual(values = c("February" = "blue", "August" = "red")) +
  theme_minimal() +
  labs(title = "Distribution of Weights by Survey",
       x = "Weight",
       y = "Frequency")


```

```{r echo=FALSE, warning=FALSE}
plot_feb <- ggplot(weights_feb_strata_man, aes(x = weight)) +
  geom_histogram(bins = 100, fill = "blue", color = "black", alpha = 0.5) +
  theme_minimal() +
  labs(title = "February: Distribution of Weights",
       x = "Weight",
       y = "Frequency")

plot_aug <- ggplot(weights_aug_strata_man, aes(x = weight)) +
  geom_histogram(bins = 100, fill = "red", color = "black", alpha = 0.5) +
  theme_minimal() +
  labs(title = "August: Distribution of Weights",
       x = "Weight",
       y = "Frequency")

grid.arrange(plot_feb, plot_aug, ncol = 2)
```

Calculating weights this way gives us the same overall picture. The main difference is in the orders of magnitude between the median weight and the tail (highest weight). 

For **February** survey, the difference (max weight / median weight) with `postStratify` is **`r round(sum_feb["Max."] / sum_feb["Median"], 2)`**, but with simple manually created weights it is **`r round(sum_man_feb["Max."] / sum_man_feb["Median"], 2)`**. For **August** survey, the difference with `postStratify` is **`r round(sum_aug["Max."] / sum_aug["Median"], 2)`**, but with simple manually created weights it is **`r round(sum_man_aug["Max."] / sum_man_aug["Median"], 2)`**.

 
```{r}
# survey_feb <- survey_feb %>%
#   left_join(weights_feb_strata_man, by = c("age_group", "gender", "university_education")) %>%
#   rename(weight_manually_calculated = weight) %>% 
#   select(-Survey)

# write.csv(survey_feb, "data/surveys/survey_feb_weights.csv", row.names = FALSE)

```


